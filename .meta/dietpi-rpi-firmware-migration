#!/bin/bash
{
# Import DietPi-Globals ---------------------------------------------------------------
. /boot/dietpi/func/dietpi-globals
readonly G_PROGRAM_NAME='dietpi-rpi-firmware-migration'
(( $G_HW_MODEL > 9 )) && { G_DIETPI-NOTIFY 1 'You can run this script on RPi systems or Trixie only!'; exit 1; }
[[ $G_DISTRO == [78] ]] || { G_DIETPI-NOTIFY 1 'You can run this script on Debian Bookworm or Trixie systems only!'; exit 1; }
G_CHECK_ROOT_USER
G_CHECK_ROOTFS_RW
G_CHECK_FREESPACE / 200
(( $(findmnt -nbo SIZE /boot) > 128000000 )) || { G_DIETPI-NOTIFY 1 'You can run this script on a system with at least 128 MiB boot partition only!'; exit 1; }
G_INIT
# Import DietPi-Globals ---------------------------------------------------------------

# Offer a backup before doing any changes to the system
G_PROMPT_BACKUP

G_DIETPI-NOTIFY 2 'Updating DietPi to latest version'
/boot/dietpi/dietpi-update 1

# Temporary rootfs mount
G_EXEC mkdir -p rootfs
G_EXEC mount "$G_ROOTFS_DEV" rootfs

# Copy DietPi files from bootfs to rootfs
G_EXEC cp -a /boot/dietpi* rootfs/boot/
G_EXEC chmod -x rootfs/boot/dietpi{.txt,/.??*,/func/dietpi-globals}

# Remount bootfs to /boot/firmware
G_EXEC mkdir -p rootfs/boot/firmware
G_EXEC sed -i 's|[[:blank:]]/boot[[:blank:]]| /boot/firmware |' /etc/fstab
G_EXEC systemctl daemon-reload
G_EXEC umount /boot
G_EXEC mount /boot/firmware
G_EXEC umount rootfs

# Generate config symlinks
G_EXEC ln -s firmware/cmdline.txt /boot/cmdline.txt
G_EXEC ln -s firmware/config.txt /boot/config.txt

# Install new firmware packages
apackages=('linux-image-rpi-v8' 'linux-image-rpi-2712')
dpkg-query -s 'raspberrypi-kernel-headers' &> /dev/null && apackages+=('linux-headers-rpi-v8' 'linux-headers-rpi-2712')
if [[ $(dpkg --print-architecture) == 'armhf' ]]
then
	apackages+=('linux-image-rpi-v6' 'linux-image-rpi-v7' 'linux-image-rpi-v7l')
	dpkg-query -s 'raspberrypi-kernel-headers' &> /dev/null && apackages+=('linux-headers-rpi-v6' 'linux-headers-rpi-v7' 'linux-headers-rpi-v7l')
	# Add foreign arm64 arch until the 64-bit kernel package has been added to the armhf repo: https://github.com/RPi-Distro/repo/issues/356
	G_EXEC dpkg --add-architecture arm64
fi
G_AGUP
G_AGI "${apackages[@]}" raspi-firmware

# Remove old firmware packages
G_AGP raspberrypi-kernel raspberrypi-headers-kernel raspberrypi-bootloader

# Remove obsolete files
G_EXEC rm -Rf /boot/firmware/{dietpi*,COPYING.linux}

G_WHIP_YESNO 'All finished!\n\nWe highly recommend to reboot, shall we reboot now?' && reboot
}